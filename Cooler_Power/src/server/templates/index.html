<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç”µæºæ¸©æ§ç³»ç»Ÿ - è¿œç¨‹æ§åˆ¶</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg: #f0f2f5; --card: #fff; --border: #e8e8e8;
  --text: #333; --text2: #8c8c8c; --text3: #bfbfbf;
  --primary: #1890ff; --success: #52c41a; --danger: #ff4d4f;
  --warning: #faad14; --purple: #722ed1;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Microsoft YaHei','Segoe UI',sans-serif; background: var(--bg);
       color: var(--text); font-size: 13px; min-height: 100vh; -webkit-text-size-adjust: 100%; }
.header { background: linear-gradient(135deg, #1890ff, #096dd9); color: #fff;
           padding: 12px 24px; display: flex; align-items: center; justify-content: space-between;
           box-shadow: 0 2px 8px rgba(0,0,0,.15); flex-wrap: wrap; gap: 8px; }
.header h1 { font-size: 18px; font-weight: 600; }
.header .status { display: flex; gap: 12px 16px; font-size: 12px; align-items: center; flex-wrap: wrap; }
.header .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
.dot-on { background: #52c41a; } .dot-off { background: #ff4d4f; } .dot-warn { background: #faad14; }

.main { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; max-width: 1600px; margin: auto; }
.full-row { grid-column: 1 / -1; }

.card { background: var(--card); border-radius: 8px; padding: 16px;
        border: 1px solid var(--border); overflow: hidden; }
.card h3 { font-size: 14px; color: var(--text); margin-bottom: 12px;
            padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }

.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.grid4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }

.val-box { background: #fafafa; border-radius: 6px; padding: 10px 12px;
           border: 1px solid #f0f0f0; min-width: 0; overflow: hidden; }
.val-box .label { color: var(--text2); font-size: 11px; margin-bottom: 4px; }
.val-box .value { font-size: 22px; font-weight: 700; color: var(--text); word-break: break-all; }
.val-box .unit { font-size: 13px; font-weight: 600; color: var(--primary); margin-left: 2px; }

.btn { border: none; border-radius: 6px; padding: 10px 18px; cursor: pointer;
       font-size: 13px; font-weight: 600; color: #fff; transition: all .2s;
       touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
.btn:hover { opacity: .85; transform: translateY(-1px); }
.btn:active { transform: translateY(0); opacity: .9; }
.btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
.btn-primary { background: var(--primary); }
.btn-success { background: var(--success); }
.btn-danger { background: var(--danger); }
.btn-warning { background: var(--warning); }
.btn-default { background: #fff; color: var(--text); border: 1px solid var(--border); }
.btn-default:hover { border-color: var(--primary); color: var(--primary); }

.btn-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

select, input[type=number] {
  border: 1px solid #d9d9d9; border-radius: 6px; padding: 8px 10px;
  font-size: 14px; background: #fff; color: var(--text); outline: none;
  -webkit-appearance: none; appearance: none; min-height: 38px;
}
select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(24,144,255,.15); }
input[type=number] { width: 100px; }

.form-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
.form-row label { color: var(--text2); font-size: 13px; white-space: nowrap; }

.status-bar { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; }
.status-item { display: flex; align-items: center; gap: 4px; }
.status-item .k { color: var(--text2); }
.status-item .v { font-weight: 600; }

.conn-status { font-weight: 600; font-size: 12px; }
.conn-on { color: var(--success); } .conn-off { color: var(--danger); }

.chart-container { position: relative; width: 100%; height: 320px; }

/* æ¸©åº¦ä¼ æ„Ÿå™¨é¢æ¿ */
.temp-panel { display: flex; gap: 16px; }
.temp-half { flex: 1; min-width: 0; }
.temp-half h4 { font-size: 13px; margin-bottom: 8px; color: var(--text); }

/* ========== å¹³æ¿é€‚é… (<=1024px) ========== */
@media (max-width: 1024px) {
  .main { grid-template-columns: 1fr; }
  .full-row { grid-column: 1; }
}

/* ========== æ‰‹æœºé€‚é… (<=640px) ========== */
@media (max-width: 640px) {
  body { font-size: 14px; }

  /* Header æ”¹ä¸ºå‚ç›´å †å  */
  .header { padding: 10px 12px; flex-direction: column; align-items: flex-start; }
  .header h1 { font-size: 16px; }
  .header .status { gap: 6px 14px; font-size: 11px; }

  /* ä¸»å¸ƒå±€ */
  .main { grid-template-columns: 1fr; gap: 10px; padding: 10px; }
  .full-row { grid-column: 1; }

  /* å¡ç‰‡ */
  .card { padding: 12px; border-radius: 8px; }
  .card h3 { font-size: 13px; margin-bottom: 10px; }

  /* ç½‘æ ¼è‡ªé€‚åº” */
  .grid4 { grid-template-columns: 1fr 1fr; gap: 8px; }
  .grid3 { grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

  /* æ•°å€¼å±•ç¤ºç¼©å° */
  .val-box { padding: 8px 10px; }
  .val-box .value { font-size: 18px; }
  .val-box .unit { font-size: 12px; }

  /* è¡¨å•è¡Œæ”¹ä¸ºçºµå‘æ’åˆ— */
  .form-row { flex-direction: column; align-items: stretch; gap: 6px; }
  .form-row label { font-size: 13px; }
  .form-row > .form-inline-group { display: flex; align-items: center; gap: 8px; }

  select, input[type=number] {
    width: 100% !important; min-width: 0 !important;
    font-size: 15px; padding: 10px 12px; min-height: 42px;
  }

  /* æŒ‰é’®æ›´å¤§æ›´æ˜“è§¦æ‘¸ */
  .btn { padding: 12px 16px; font-size: 14px; border-radius: 8px;
         min-height: 44px; flex: 1; min-width: 0; text-align: center; }
  .btn-row { gap: 8px; }
  .btn-row .conn-status { flex-basis: 100%; text-align: center; margin-top: 4px; }

  /* æ¸©åº¦ä¼ æ„Ÿå™¨é¢æ¿æ”¹ä¸ºä¸Šä¸‹å †å  */
  .temp-panel { flex-direction: column; gap: 16px; }
  .temp-half { flex: none; width: 100%; }
  .temp-half .grid3 { grid-template-columns: 1fr 1fr 1fr; }

  /* å›¾è¡¨å®¹å™¨é€‚é… */
  .chart-container { height: 250px; }

  /* PID è¡¨å•ä¸­ inline style çš„è¦†ç›– */
  .form-row span { font-size: 14px; }
}

/* ========== æå°å±é€‚é… (<=380px) ========== */
@media (max-width: 380px) {
  .header h1 { font-size: 14px; }
  .grid4, .grid3 { grid-template-columns: 1fr 1fr; gap: 6px; }
  .val-box .value { font-size: 16px; }
  .chart-container { height: 200px; }
  .btn { padding: 10px 12px; font-size: 13px; }
  .temp-half .grid3 { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<div class="header">
  <h1>âš¡ ç”µæºæ¸©æ§ç³»ç»Ÿ - è¿œç¨‹æ§åˆ¶é¢æ¿</h1>
  <div class="status">
    <span><span class="dot dot-off" id="hdr_power_dot"></span>ç”µæº: <span id="hdr_power">æœªè¿æ¥</span></span>
    <span><span class="dot dot-off" id="hdr_temp1_dot"></span>æ¸©åº¦1: <span id="hdr_temp1">æœªè¿æ¥</span></span>
    <span><span class="dot dot-off" id="hdr_temp2_dot"></span>æ¸©åº¦2: <span id="hdr_temp2">æœªè¿æ¥</span></span>
    <span><span class="dot dot-off" id="hdr_ws_dot"></span>WebSocket: <span id="hdr_ws">æ–­å¼€</span></span>
    <span style="opacity:.6" id="update_time">--</span>
  </div>
</div>

<div class="main">

  <!-- ================== ç”µæºæ§åˆ¶ ================== -->
  <div class="card">
    <h3>ğŸ”Œ ç”µæºè¿æ¥</h3>
    <div class="form-row">
      <label>ä¸²å£:</label>
      <select id="power_port"><option value="">ç‚¹å‡»åˆ·æ–°è·å–ä¸²å£</option></select>
    </div>
    <div class="form-row" style="flex-direction:row;flex-wrap:wrap;">
      <button class="btn btn-default" onclick="refreshPorts()" style="flex:none;">åˆ·æ–°ä¸²å£</button>
    </div>
    <div class="form-row">
      <label>æ³¢ç‰¹ç‡:</label>
      <select id="power_baud">
        <option>9600</option><option>19200</option><option>38400</option><option>57600</option><option>115200</option>
      </select>
    </div>
    <div class="form-row">
      <label>åœ°å€:</label>
      <input type="number" id="power_addr" value="1" min="1" max="127">
    </div>
    <div class="btn-row">
      <button class="btn btn-success" id="btn_power_conn" onclick="powerConnect()">è¿æ¥</button>
      <button class="btn btn-danger" id="btn_power_disc" onclick="powerDisconnect()" disabled>æ–­å¼€</button>
      <span class="conn-status conn-off" id="power_status">â— æœªè¿æ¥</span>
    </div>
  </div>

  <!-- ================== è¾“å‡ºæ§åˆ¶ ================== -->
  <div class="card">
    <h3>âš¡ è¾“å‡ºæ§åˆ¶</h3>
    <div class="form-row">
      <label>è®¾å®šç”µå‹ (V):</label>
      <input type="number" id="set_v" value="12.000" step="0.1" min="0" max="60">
      <button class="btn btn-primary" onclick="setVoltage()" style="flex:none;">è®¾ç½®ç”µå‹</button>
    </div>
    <div class="form-row">
      <label>è®¾å®šç”µæµé™åˆ¶ (A):</label>
      <input type="number" id="set_i" value="7.000" step="0.1" min="0" max="20">
      <button class="btn btn-primary" onclick="setCurrent()" style="flex:none;">è®¾ç½®ç”µæµ</button>
    </div>
    <div class="btn-row">
      <button class="btn btn-success" onclick="outputOn()">å¼€å¯è¾“å‡º</button>
      <button class="btn btn-danger" onclick="outputOff()">å…³é—­è¾“å‡º</button>
    </div>
    <div class="status-bar" style="margin-top:10px;">
      <span class="status-item"><span class="k">è¾“å‡ºçŠ¶æ€:</span> <strong class="v" id="output_indicator" style="font-size:16px;">--</strong></span>
      <span class="status-item"><span class="k">ä¿æŠ¤:</span> <strong class="v" id="prot_status" style="color:var(--success);">æ­£å¸¸</strong></span>
    </div>
  </div>

  <!-- ================== å®æ—¶ç›‘æµ‹ ================== -->
  <div class="card full-row">
    <h3>ğŸ“Š å®æ—¶ç›‘æµ‹</h3>
    <div class="grid4">
      <div class="val-box">
        <div class="label">è¾“å‡ºç”µå‹</div>
        <div><span class="value" id="v_real">---.---</span><span class="unit">V</span></div>
      </div>
      <div class="val-box">
        <div class="label">è¾“å‡ºç”µæµ</div>
        <div><span class="value" id="i_real">---.---</span><span class="unit">A</span></div>
      </div>
      <div class="val-box">
        <div class="label">è¾“å‡ºåŠŸç‡</div>
        <div><span class="value" id="p_real">---.--</span><span class="unit">W</span></div>
      </div>
      <div class="val-box">
        <div class="label">å·¥ä½œæ¨¡å¼ / æ¸©åº¦</div>
        <div><span class="value" id="mode_temp">-- / --â„ƒ</span></div>
      </div>
    </div>
  </div>

  <!-- ================== æ¸©åº¦ä¼ æ„Ÿå™¨ ================== -->
  <div class="card full-row">
    <h3>ğŸŒ¡ æ¸©åº¦ä¼ æ„Ÿå™¨</h3>
    <div class="temp-panel">
      <div class="temp-half">
        <h4>ä¼ æ„Ÿå™¨ 1 &nbsp;<span class="conn-status conn-off" id="temp1_status">â— æœªè¿æ¥</span></h4>
        <div class="form-row">
          <label>ä¸²å£:</label>
          <select id="temp1_port"><option value="">--</option></select>
        </div>
        <div class="btn-row" style="margin-bottom:10px;">
          <button class="btn btn-success" onclick="tempConnect(1)">è¿æ¥</button>
          <button class="btn btn-danger" onclick="tempDisconnect(1)">æ–­å¼€</button>
        </div>
        <div class="grid3">
          <div class="val-box"><div class="label">DS18B20</div><div><span class="value" id="t1_ds">--</span><span class="unit">â„ƒ</span></div></div>
          <div class="val-box"><div class="label">çƒ­ç«¯æ¸©åº¦</div><div><span class="value" id="t1_hot">--</span><span class="unit">â„ƒ</span></div></div>
          <div class="val-box"><div class="label">å†·ç«¯æ¸©åº¦</div><div><span class="value" id="t1_cold">--</span><span class="unit">â„ƒ</span></div></div>
        </div>
      </div>
      <div class="temp-half">
        <h4>ä¼ æ„Ÿå™¨ 2 &nbsp;<span class="conn-status conn-off" id="temp2_status">â— æœªè¿æ¥</span></h4>
        <div class="form-row">
          <label>ä¸²å£:</label>
          <select id="temp2_port"><option value="">--</option></select>
        </div>
        <div class="btn-row" style="margin-bottom:10px;">
          <button class="btn btn-success" onclick="tempConnect(2)">è¿æ¥</button>
          <button class="btn btn-danger" onclick="tempDisconnect(2)">æ–­å¼€</button>
        </div>
        <div class="grid3">
          <div class="val-box"><div class="label">DS18B20</div><div><span class="value" id="t2_ds">--</span><span class="unit">â„ƒ</span></div></div>
          <div class="val-box"><div class="label">çƒ­ç«¯æ¸©åº¦</div><div><span class="value" id="t2_hot">--</span><span class="unit">â„ƒ</span></div></div>
          <div class="val-box"><div class="label">å†·ç«¯æ¸©åº¦</div><div><span class="value" id="t2_cold">--</span><span class="unit">â„ƒ</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== PID æ¸©åº¦æ§åˆ¶ ================== -->
  <div class="card">
    <h3>ğŸ› PID æ¸©åº¦æ§åˆ¶</h3>
    <div class="form-row">
      <label>èåˆç­–ç•¥:</label>
      <select id="fusion_mode">
        <option value="0">åŒä¼ æ„Ÿå™¨å¹³å‡</option><option value="1">ä»…ä¼ æ„Ÿå™¨1</option><option value="2">ä»…ä¼ æ„Ÿå™¨2</option>
      </select>
    </div>
    <div class="form-row">
      <label>æ§åˆ¶æ¨¡å¼:</label>
      <select id="control_mode">
        <option value="0">åˆ¶å†·æ¨¡å¼</option><option value="1">åˆ¶çƒ­æ¨¡å¼</option>
      </select>
    </div>
    <div class="form-row">
      <label>ç›®æ ‡æ¸©åº¦ (â„ƒ):</label>
      <input type="number" id="pid_target" value="15.00" step="0.5" min="-20" max="80">
    </div>
    <div class="form-row">
      <label style="color:var(--danger);font-weight:600;">âš  å®‰å…¨ä¸Šé™ (â„ƒ):</label>
      <input type="number" id="pid_safety" value="30.0" step="1" min="0" max="80">
    </div>
    <div class="form-row">
      <label>Kp:</label>
      <input type="number" id="pid_kp" value="1.00" step="0.1" min="0" max="50">
    </div>
    <div class="form-row">
      <label>Ki:</label>
      <input type="number" id="pid_ki" value="0.050" step="0.01" min="0" max="10">
    </div>
    <div class="form-row">
      <label>Kd:</label>
      <input type="number" id="pid_kd" value="0.50" step="0.1" min="0" max="50">
    </div>
    <div class="form-row">
      <label>æœ€å¤§ç”µæµ (A):</label>
      <input type="number" id="pid_max_i" value="7.000" step="0.5" min="0.1" max="14">
    </div>
    <div class="form-row">
      <label>æœ€å¤§ç”µå‹ (V):</label>
      <input type="number" id="pid_max_v" value="12.0" step="1" min="1" max="15">
    </div>
    <div class="form-row">
      <label>æ§åˆ¶å‘¨æœŸ (s):</label>
      <input type="number" id="pid_interval" value="1.0" step="0.5" min="0.5" max="10">
    </div>
    <div class="btn-row" style="margin-top:8px;">
      <button class="btn btn-primary" onclick="updatePidParams()">åº”ç”¨å‚æ•°</button>
      <button class="btn btn-warning" onclick="autoTune()">ğŸ”§ æ•´å®š</button>
      <button class="btn btn-success" id="btn_pid_start" onclick="startPid()">â–¶ å¯åŠ¨</button>
      <button class="btn btn-danger" id="btn_pid_stop" onclick="stopPid()" disabled>â¹ åœæ­¢</button>
      <button class="btn btn-default" onclick="applyTune()">âœ“ åº”ç”¨æ•´å®š</button>
    </div>
    <div id="tune_msg" style="margin-top:6px;color:var(--text3);font-size:11px;">æœªæ•´å®š â€” ä½¿ç”¨é»˜è®¤å‚æ•°</div>
  </div>

  <!-- ================== æ§åˆ¶çŠ¶æ€ ================== -->
  <div class="card">
    <h3>ğŸ“ˆ æ§åˆ¶çŠ¶æ€</h3>
    <div class="grid3">
      <div class="val-box"><div class="label">æ§åˆ¶çŠ¶æ€</div><div class="value" id="ctrl_status" style="font-size:14px;color:var(--text3);">â— æœªå¯åŠ¨</div></div>
      <div class="val-box"><div class="label">å½“å‰æ¸©åº¦</div><div><span class="value" id="ctrl_temp">--</span><span class="unit">â„ƒ</span></div></div>
      <div class="val-box"><div class="label">ç›®æ ‡æ¸©åº¦</div><div><span class="value" id="ctrl_target">--</span><span class="unit">â„ƒ</span></div></div>
    </div>
    <div class="grid3" style="margin-top:8px;">
      <div class="val-box"><div class="label">æ¸©åº¦åå·®</div><div><span class="value" id="ctrl_error">--</span><span class="unit">â„ƒ</span></div></div>
      <div class="val-box"><div class="label">è¾“å‡ºç”µæµ</div><div><span class="value" id="ctrl_output">--</span><span class="unit">A</span></div></div>
      <div class="val-box"><div class="label">è¿è¡Œæ—¶é—´</div><div class="value" id="ctrl_time" style="font-size:16px;">00:00:00</div></div>
    </div>
  </div>

  <!-- ================== æ¸©åº¦æ›²çº¿å›¾ ================== -->
  <div class="card full-row">
    <h3>ğŸ“‰ æ¸©åº¦æ›²çº¿</h3>
    <div class="chart-container">
      <canvas id="tempChart"></canvas>
    </div>
  </div>

</div>

<script>
// ==================== å…¨å±€å˜é‡ ====================
let ws = null;
let chart = null;
const API = window.location.origin;

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', () => {
  initChart();
  connectWebSocket();
  refreshPorts();
  // æ¯ 30s åˆ·æ–°å†å²æ•°æ®ä»¥é˜² WS æ–­å¼€
  setInterval(fetchHistory, 30000);
});

// ==================== WebSocket ====================
function connectWebSocket() {
  const wsUrl = `ws://${window.location.host}/ws`;
  ws = new WebSocket(wsUrl);

  ws.onopen = () => {
    document.getElementById('hdr_ws').textContent = 'å·²è¿æ¥';
    document.getElementById('hdr_ws_dot').className = 'dot dot-on';
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'state') updateUI(msg.data);
  };

  ws.onclose = () => {
    document.getElementById('hdr_ws').textContent = 'æ–­å¼€';
    document.getElementById('hdr_ws_dot').className = 'dot dot-off';
    setTimeout(connectWebSocket, 3000);
  };

  ws.onerror = () => { ws.close(); };
}

// ==================== UI æ›´æ–° ====================
function updateUI(s) {
  // å¤´éƒ¨çŠ¶æ€
  setConnDot('hdr_power_dot', 'hdr_power', s.power_connected);
  setConnDot('hdr_temp1_dot', 'hdr_temp1', s.temp1_connected);
  setConnDot('hdr_temp2_dot', 'hdr_temp2', s.temp2_connected);

  // ç”µæºè¿æ¥çŠ¶æ€
  const ps = document.getElementById('power_status');
  setBtnState(s.power_connected);
  if (s.power_connected) {
    ps.textContent = 'â— å·²è¿æ¥'; ps.className = 'conn-status conn-on';
  } else {
    ps.textContent = 'â— æœªè¿æ¥'; ps.className = 'conn-status conn-off';
  }

  // å®æ—¶æ•°å€¼
  setText('v_real', s.voltage_real.toFixed(3));
  setText('i_real', s.current_real.toFixed(3));
  setText('p_real', s.power_real.toFixed(2));
  setText('mode_temp', `${s.power_mode} / ${s.power_temperature.toFixed(0)}â„ƒ`);

  // è¾“å‡ºæŒ‡ç¤º
  const oi = document.getElementById('output_indicator');
  if (s.is_output_on) { oi.textContent = 'ON'; oi.style.color = 'var(--success)'; }
  else { oi.textContent = 'OFF'; oi.style.color = 'var(--danger)'; }

  const pp = document.getElementById('prot_status');
  pp.textContent = s.protection_status;
  pp.style.color = s.protection_status === 'æ­£å¸¸' ? 'var(--success)' : 'var(--danger)';

  // æ¸©åº¦ä¼ æ„Ÿå™¨
  setTempConn(1, s.temp1_connected);
  setTempConn(2, s.temp2_connected);
  setText('t1_ds', s.temp1_ds18b20); setText('t1_hot', s.temp1_hot); setText('t1_cold', s.temp1_cold);
  setText('t2_ds', s.temp2_ds18b20); setText('t2_hot', s.temp2_hot); setText('t2_cold', s.temp2_cold);

  // PID çŠ¶æ€
  const cs = document.getElementById('ctrl_status');
  if (s.pid_auto_tuning) { cs.textContent = 'â— è‡ªåŠ¨æ•´å®šä¸­'; cs.style.color = 'var(--warning)'; }
  else if (s.pid_enabled) { cs.textContent = 'â— è¿è¡Œä¸­'; cs.style.color = 'var(--success)'; }
  else { cs.textContent = 'â— æœªå¯åŠ¨'; cs.style.color = 'var(--text3)'; }

  document.getElementById('btn_pid_start').disabled = s.pid_enabled;
  document.getElementById('btn_pid_stop').disabled = !s.pid_enabled;

  if (s.fused_temp !== null) setText('ctrl_temp', s.fused_temp.toFixed(2));
  setText('ctrl_target', s.target_temp.toFixed(2));
  const errEl = document.getElementById('ctrl_error');
  errEl.textContent = s.temp_error.toFixed(2);
  errEl.style.color = Math.abs(s.temp_error) > 1 ? 'var(--danger)' : 'var(--success)';
  setText('ctrl_output', s.pid_output.toFixed(3));

  const el = s.control_elapsed;
  const h = Math.floor(el / 3600), m = Math.floor((el % 3600) / 60), sec = Math.floor(el % 60);
  setText('ctrl_time', `${pad(h)}:${pad(m)}:${pad(sec)}`);

  if (s.auto_tune_message) {
    document.getElementById('tune_msg').textContent = s.auto_tune_message;
  }

  // æ›´æ–°æ—¶é—´
  if (s.updated_at > 0) {
    const d = new Date(s.updated_at * 1000);
    document.getElementById('update_time').textContent = d.toLocaleTimeString();
  }
}

function setConnDot(dotId, txtId, connected) {
  document.getElementById(dotId).className = connected ? 'dot dot-on' : 'dot dot-off';
  document.getElementById(txtId).textContent = connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
}

function setTempConn(idx, connected) {
  const el = document.getElementById(`temp${idx}_status`);
  el.textContent = connected ? 'â— å·²è¿æ¥' : 'â— æœªè¿æ¥';
  el.className = connected ? 'conn-status conn-on' : 'conn-status conn-off';
}

function setBtnState(connected) {
  document.getElementById('btn_power_conn').disabled = connected;
  document.getElementById('btn_power_disc').disabled = !connected;
}

function setText(id, val) { document.getElementById(id).textContent = val; }
function pad(n) { return n.toString().padStart(2, '0'); }

// ==================== Chart.js ====================
function initChart() {
  const ctx = document.getElementById('tempChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'ç›®æ ‡', data: [], borderColor: '#52c41a', borderDash: [6,3], borderWidth: 2.5, pointRadius: 0, yAxisID: 'y', tension: 0.1 },
        { label: 'å†·ç«¯1', data: [], borderColor: '#1890ff', borderWidth: 2, pointRadius: 0, yAxisID: 'y', tension: 0.2 },
        { label: 'çƒ­ç«¯1', data: [], borderColor: '#ff7875', borderWidth: 1.5, borderDash: [4,2], pointRadius: 0, yAxisID: 'y', tension: 0.2 },
        { label: 'å†·ç«¯2', data: [], borderColor: '#722ed1', borderWidth: 2, pointRadius: 0, yAxisID: 'y', tension: 0.2 },
        { label: 'çƒ­ç«¯2', data: [], borderColor: '#eb2f96', borderWidth: 1.5, borderDash: [4,2], pointRadius: 0, yAxisID: 'y', tension: 0.2 },
        { label: 'è¾“å‡ºç”µæµ', data: [], borderColor: '#faad14', borderWidth: 2, pointRadius: 0, yAxisID: 'y1', tension: 0.2 },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 300 },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { font: { size: 11 }, usePointStyle: true, pointStyle: 'line' } },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { title: { display: true, text: 'æ—¶é—´ (s)', font: { size: 11 } },
             ticks: { font: { size: 10 }, maxTicksLimit: 20 } },
        y: { title: { display: true, text: 'æ¸©åº¦ (â„ƒ)', font: { size: 11 }, color: '#1890ff' },
             position: 'left', ticks: { font: { size: 10 } }, grid: { color: 'rgba(0,0,0,0.06)' } },
        y1:{ title: { display: true, text: 'ç”µæµ (A)', font: { size: 11 }, color: '#faad14' },
             position: 'right', ticks: { font: { size: 10 } }, grid: { drawOnChartArea: false } }
      }
    }
  });
}

function updateChart(history) {
  if (!chart || !history || !history.time) return;
  chart.data.labels = history.time;
  chart.data.datasets[0].data = history.target;
  chart.data.datasets[1].data = history.cold1;
  chart.data.datasets[2].data = history.hot1;
  chart.data.datasets[3].data = history.cold2;
  chart.data.datasets[4].data = history.hot2;
  chart.data.datasets[5].data = history.output;
  chart.update('none');
}

async function fetchHistory() {
  try {
    const r = await fetch(API + '/api/history');
    const data = await r.json();
    updateChart(data);
  } catch(e) { console.warn('fetchHistory error', e); }
}

// æ¯ 2s æ‹‰å–å†å²æ•°æ®æ›´æ–°å›¾è¡¨
setInterval(fetchHistory, 2000);

// ==================== API è°ƒç”¨ ====================
async function api(path, body = null) {
  try {
    const opt = body !== null
      ? { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }
      : { method:'POST' };
    const r = await fetch(API + path, opt);
    return await r.json();
  } catch(e) { console.error('API error', e); return null; }
}

async function refreshPorts() {
  try {
    const r = await fetch(API + '/api/ports');
    const ports = await r.json();
    ['power_port','temp1_port','temp2_port'].forEach(id => {
      const sel = document.getElementById(id);
      const old = sel.value;
      sel.innerHTML = '<option value="">-- é€‰æ‹©ä¸²å£ --</option>';
      ports.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.device;
        opt.textContent = `${p.device} - ${p.description}`;
        sel.appendChild(opt);
      });
      if (old) sel.value = old;
    });
  } catch(e) { console.warn('refreshPorts error', e); }
}

function powerConnect() {
  const port = document.getElementById('power_port').value;
  if (!port) return alert('è¯·é€‰æ‹©ä¸²å£');
  api('/api/power/connect', {
    port, baudrate: parseInt(document.getElementById('power_baud').value),
    address: parseInt(document.getElementById('power_addr').value)
  });
}

function powerDisconnect() { api('/api/power/disconnect'); }
function setVoltage() { api('/api/power/set_voltage', { voltage: parseFloat(document.getElementById('set_v').value) }); }
function setCurrent() { api('/api/power/set_current', { current: parseFloat(document.getElementById('set_i').value) }); }
function outputOn() { api('/api/power/output_on'); }
function outputOff() { api('/api/power/output_off'); }

function tempConnect(idx) {
  const port = document.getElementById(`temp${idx}_port`).value;
  if (!port) return alert('è¯·é€‰æ‹©ä¸²å£');
  api('/api/temp/connect', { index: idx, port });
}
function tempDisconnect(idx) { api('/api/temp/disconnect', { index: idx, port: '' }); }

function updatePidParams() {
  api('/api/pid/update_params', {
    kp: parseFloat(document.getElementById('pid_kp').value),
    ki: parseFloat(document.getElementById('pid_ki').value),
    kd: parseFloat(document.getElementById('pid_kd').value),
    max_current: parseFloat(document.getElementById('pid_max_i').value),
    max_voltage: parseFloat(document.getElementById('pid_max_v').value),
    control_interval: parseFloat(document.getElementById('pid_interval').value),
    target_temp: parseFloat(document.getElementById('pid_target').value),
    safety_temp: parseFloat(document.getElementById('pid_safety').value),
    fusion_mode: parseInt(document.getElementById('fusion_mode').value),
    control_mode: parseInt(document.getElementById('control_mode').value),
  });
}

function startPid() { updatePidParams(); api('/api/pid/start'); }
function stopPid() { api('/api/pid/stop'); }
function autoTune() { updatePidParams(); api('/api/pid/auto_tune'); }
function applyTune() { api('/api/pid/apply_tune'); }
</script>
</body>
</html>
