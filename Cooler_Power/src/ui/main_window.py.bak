#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
CL-500W 可调电源控制器 - 主界面

现代化风格的 Qt 界面，用于控制 CL-500W 可调电源。
界面风格参考专业设备控制软件设计。

支持:
- 电压/电流设定（圆形旋钮风格）
- 输出开关控制
- 实时状态监控
- 串口连接管理

作者: AI协作团队
日期: 2026-02-05
更新: 2026-02-07 - 现代化界面风格
"""

import sys
import math
import re
import threading
from typing import Optional
from PySide6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QGroupBox, QLabel, QLineEdit, QPushButton, QComboBox,
    QGridLayout, QFrame, QMessageBox, QSpinBox, QDoubleSpinBox,
    QProgressBar, QSlider, QStackedWidget, QScrollArea, QSizePolicy
)
from PySide6.QtCore import Qt, QTimer, Signal, Slot, QRect
from PySide6.QtGui import QFont, QPalette, QColor, QIcon, QPainter, QPen, QBrush

import serial
import serial.tools.list_ports

# 导入驱动
try:
    from ..drivers.cl500w_driver import CL500WDriver
    from ..protocol.power_supply_base import PowerStatus, PowerMode, ProtectionStatus
except ImportError:
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent.parent))
    from src.drivers.cl500w_driver import CL500WDriver
    from src.protocol.power_supply_base import PowerStatus, PowerMode, ProtectionStatus


# ==================== 样式定义 ====================

MODERN_STYLE = """
/* 全局样式 - 现代浅色主题 */
QMainWindow {
    background-color: #f0f0f0;
}

QWidget {
    background-color: transparent;
    color: #333333;
    font-family: "Microsoft YaHei", "Segoe UI", Arial;
    font-size: 12px;
}

/* 内容区域 */
QWidget#content_area {
    background-color: #ffffff;
    border-radius: 8px;
}

/* 模块选择按钮 - 蓝色主按钮 */
QPushButton#module_btn_active {
    background-color: #1890ff;
    color: #ffffff;
    border: none;
    border-radius: 4px;
    padding: 8px 20px;
    font-size: 13px;
    font-weight: bold;
}

QPushButton#module_btn_active:hover {
    background-color: #40a9ff;
}

QPushButton#module_btn_inactive {
    background-color: #ffffff;
    color: #333333;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    padding: 8px 20px;
    font-size: 13px;
}

QPushButton#module_btn_inactive:hover {
    background-color: #f5f5f5;
    border-color: #1890ff;
    color: #1890ff;
}

/* 选项卡按钮 - 橙色激活状态 */
QPushButton#tab_btn_active {
    background-color: #fa541c;
    color: #ffffff;
    border: none;
    border-radius: 4px;
    padding: 6px 16px;
    font-size: 12px;
}

QPushButton#tab_btn_inactive {
    background-color: transparent;
    color: #595959;
    border: none;
    border-radius: 4px;
    padding: 6px 16px;
    font-size: 12px;
}

QPushButton#tab_btn_inactive:hover {
    background-color: #fff2e8;
    color: #fa541c;
}

/* 分组框 */
QGroupBox {
    font-size: 13px;
    font-weight: bold;
    color: #262626;
    border: none;
    margin-top: 8px;
    padding-top: 8px;
    background-color: transparent;
}

QGroupBox::title {
    subcontrol-origin: margin;
    subcontrol-position: top left;
    left: 0px;
    padding: 0 4px;
}

/* 标签 */
QLabel {
    color: #595959;
    font-size: 12px;
    background-color: transparent;
}

QLabel#section_title {
    color: #262626;
    font-size: 14px;
    font-weight: bold;
}

/* 输入框 */
QLineEdit {
    background-color: #ffffff;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    padding: 6px 10px;
    color: #333333;
    font-size: 12px;
}

QSpinBox, QDoubleSpinBox {
    background-color: #ffffff;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    padding: 4px;
    color: #333333;
    font-size: 12px;
    min-height: 22px;
}

QLineEdit:focus, QSpinBox:focus, QDoubleSpinBox:focus {
    border: 1px solid #1890ff;
}

QLineEdit:disabled, QSpinBox:disabled, QDoubleSpinBox:disabled {
    background-color: #f5f5f5;
    color: #bfbfbf;
}

/* 下拉框 */
QComboBox {
    background-color: #ffffff;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    padding: 6px 10px;
    color: #333333;
    font-size: 12px;
    min-width: 80px;
}

QComboBox:hover {
    border-color: #1890ff;
}

QComboBox::drop-down {
    border: none;
    width: 20px;
}

QComboBox QAbstractItemView {
    background-color: #ffffff;
    border: 1px solid #d9d9d9;
    selection-background-color: #e6f7ff;
    selection-color: #1890ff;
}

/* 按钮基础样式 */
QPushButton {
    background-color: #ffffff;
    color: #333333;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    padding: 6px 16px;
    font-size: 12px;
}

QPushButton:hover {
    border-color: #1890ff;
    color: #1890ff;
}

QPushButton:pressed {
    background-color: #e6f7ff;
}

QPushButton:disabled {
    background-color: #f5f5f5;
    color: #bfbfbf;
    border-color: #d9d9d9;
}

/* 主要按钮 - 蓝色 */
QPushButton#primary_btn {
    background-color: #1890ff;
    color: #ffffff;
    border: none;
}

QPushButton#primary_btn:hover {
    background-color: #40a9ff;
}

QPushButton#primary_btn:disabled {
    background-color: #bfbfbf;
}

/* 成功按钮 - 绿色 */
QPushButton#success_btn {
    background-color: #52c41a;
    color: #ffffff;
    border: none;
    font-weight: bold;
}

QPushButton#success_btn:hover {
    background-color: #73d13d;
}

/* 危险按钮 - 红色 */
QPushButton#danger_btn {
    background-color: #ff4d4f;
    color: #ffffff;
    border: none;
    font-weight: bold;
}

QPushButton#danger_btn:hover {
    background-color: #ff7875;
}

/* 滑动条 */
QSlider::groove:vertical {
    background: #f0f0f0;
    width: 6px;
    border-radius: 3px;
}

QSlider::handle:vertical {
    background: #1890ff;
    height: 16px;
    width: 16px;
    margin: 0 -5px;
    border-radius: 8px;
}

/* 状态指示 */
QLabel#status_connected {
    color: #52c41a;
    font-weight: bold;
}

QLabel#status_disconnected {
    color: #ff4d4f;
    font-weight: bold;
}

/* 状态栏 */
QFrame#status_bar {
    background-color: #fafafa;
    border-top: 1px solid #f0f0f0;
}

/* 数值显示标签 */
QLabel.value_display {
    font-size: 28px;
    font-weight: bold;
    color: #2c3e50;
    background-color: #ecf0f1;
    border: 2px solid #bdc3c7;
    border-radius: 8px;
    padding: 10px 20px;
    qproperty-alignment: AlignCenter;
}

/* CV/CC 模式指示 */
QLabel#mode_cv {
    color: #3498db;
    font-weight: bold;
    font-size: 14px;
}

QLabel#mode_cc {
    color: #e67e22;
    font-weight: bold;
    font-size: 14px;
}

/* 保护状态 */
QLabel#protection_normal {
    color: #27ae60;
}

QLabel#protection_warning {
    color: #e74c3c;
    font-weight: bold;
}

/* 进度条 */
QProgressBar {
    border: 1px solid #bdc3c7;
    border-radius: 4px;
    background-color: #ecf0f1;
    text-align: center;
    color: #333333;
}

QProgressBar::chunk {
    background-color: #3498db;
    border-radius: 3px;
}

/* 分隔线 */
QFrame[frameShape="4"], QFrame[frameShape="5"] {
    color: #bdc3c7;
}
"""


class CircularGauge(QWidget):
    """
    圆形仪表盘控件
    
    显示电压/电流值，带有圆弧进度指示
    """
    
    valueChanged = Signal(float)
    
    def __init__(self, title: str, unit: str, min_val: float = 0, max_val: float = 100,
                 color: str = "#1890ff", parent=None):
        super().__init__(parent)
        
        self.title = title
        self.unit = unit
        self.min_val = min_val
        self.max_val = max_val
        self.color = QColor(color)
        self._value = 0.0
        self._is_editable = False
        
        self.setMinimumSize(130, 170)
        self.setMaximumSize(160, 200)
        
        self._setup_ui()
    
    def _setup_ui(self):
        """设置 UI"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(5, 5, 5, 5)
        layout.setSpacing(4)
        
        # 标题
        self.title_label = QLabel(self.title)
        self.title_label.setAlignment(Qt.AlignCenter)
        self.title_label.setStyleSheet("font-size: 11px; color: #8c8c8c; font-weight: normal;")
        layout.addWidget(self.title_label)
        
        # 圆形区域（用于绘制）
        self.gauge_widget = QWidget()
        self.gauge_widget.setMinimumSize(100, 100)
        self.gauge_widget.paintEvent = self._paint_gauge
        layout.addWidget(self.gauge_widget, alignment=Qt.AlignCenter)
        
        # 底部控制区
        bottom_layout = QHBoxLayout()
        bottom_layout.setSpacing(4)
        
        # 数值输入
        self.value_input = QDoubleSpinBox()
        self.value_input.setRange(self.min_val, self.max_val)
        self.value_input.setDecimals(1)
        self.value_input.setSingleStep(0.1)
        self.value_input.setFixedWidth(80)
        self.value_input.setFixedHeight(26)
        self.value_input.setEnabled(False)
        bottom_layout.addWidget(self.value_input)
        
        # 单位
        unit_label = QLabel(self.unit)
        unit_label.setStyleSheet("font-size: 11px; color: #8c8c8c;")
        bottom_layout.addWidget(unit_label)
        
        # Sync 标签
        sync_label = QLabel("Sync")
        sync_label.setStyleSheet("font-size: 10px; color: #bfbfbf;")
        bottom_layout.addWidget(sync_label)
        
        layout.addLayout(bottom_layout)
    
    def _paint_gauge(self, event):
        """绘制圆形仪表"""
        painter = QPainter(self.gauge_widget)
        painter.setRenderHint(QPainter.Antialiasing)
        
        # 计算绘制区域
        rect = self.gauge_widget.rect()
        size = min(rect.width(), rect.height()) - 10
        x = (rect.width() - size) // 2
        y = (rect.height() - size) // 2
        
        gauge_rect = QRect(x, y, size, size)
        center = gauge_rect.center()
        radius = size // 2 - 5
        
        # 绘制背景圆弧（灰色）
        pen = QPen(QColor("#f0f0f0"), 8, Qt.SolidLine, Qt.RoundCap)
        painter.setPen(pen)
        painter.drawArc(gauge_rect.adjusted(5, 5, -5, -5), 225 * 16, -270 * 16)
        
        # 绘制进度圆弧
        if self.max_val > self.min_val:
            progress = (self._value - self.min_val) / (self.max_val - self.min_val)
            progress = max(0, min(1, progress))
            
            # 根据进度选择颜色
            if progress > 0.8:
                arc_color = QColor("#ff4d4f")  # 红色警告
            elif progress > 0.6:
                arc_color = QColor("#faad14")  # 橙色
            else:
                arc_color = self.color
            
            pen = QPen(arc_color, 8, Qt.SolidLine, Qt.RoundCap)
            painter.setPen(pen)
            span_angle = int(-270 * 16 * progress)
            painter.drawArc(gauge_rect.adjusted(5, 5, -5, -5), 225 * 16, span_angle)
        
        # 绘制内圆（白色背景）
        inner_radius = radius - 12
        inner_rect = QRect(center.x() - inner_radius, center.y() - inner_radius,
                          inner_radius * 2, inner_radius * 2)
        painter.setPen(Qt.NoPen)
        painter.setBrush(QBrush(QColor("#ffffff")))
        painter.drawEllipse(inner_rect)
        
        # 绘制数值
        painter.setPen(QColor("#262626"))
        font = painter.font()
        font.setPointSize(14)
        font.setBold(True)
        painter.setFont(font)
        
        value_text = f"{self._value:.1f}{self.unit}"
        painter.drawText(inner_rect, Qt.AlignCenter, value_text)
        
        painter.end()
    
    def set_value(self, value: float):
        """设置显示值"""
        self._value = value
        self.value_input.setValue(value)
        self.gauge_widget.update()
    
    def get_value(self) -> float:
        """获取当前值"""
        return self._value
    
    def set_editable(self, editable: bool):
        """设置是否可编辑"""
        self._is_editable = editable
        self.value_input.setEnabled(editable)
    
    def set_color(self, color: str):
        """设置颜色"""
        self.color = QColor(color)
        self.gauge_widget.update()


class ValueDisplay(QFrame):
    """现代风格的数值显示组件"""
    
    def __init__(self, title: str, unit: str, decimals: int = 3, parent=None):
        super().__init__(parent)
        self.decimals = decimals
        self.unit = unit
        
        self.setFrameStyle(QFrame.StyledPanel)
        self.setStyleSheet("""
            QFrame {
                background-color: #fafafa;
                border: 1px solid #f0f0f0;
                border-radius: 8px;
            }
        """)
        
        layout = QVBoxLayout(self)
        layout.setSpacing(4)
        layout.setContentsMargins(12, 8, 12, 8)
        
        # 标题
        self.title_label = QLabel(title)
        self.title_label.setStyleSheet("font-size: 11px; color: #8c8c8c; border: none; background: transparent;")
        layout.addWidget(self.title_label)
        
        # 数值行
        value_layout = QHBoxLayout()
        value_layout.setSpacing(4)
        
        self.value_label = QLabel("---.---")
        self.value_label.setStyleSheet("""
            font-size: 24px;
            font-weight: bold;
            color: #262626;
            border: none;
            background: transparent;
        """)
        value_layout.addWidget(self.value_label)
        
        self.unit_label = QLabel(unit)
        self.unit_label.setStyleSheet("font-size: 14px; color: #1890ff; font-weight: bold; border: none; background: transparent;")
        value_layout.addWidget(self.unit_label)
        value_layout.addStretch()
        
        layout.addLayout(value_layout)
    
    def set_value(self, value: float):
        """设置显示值"""
        self.value_label.setText(f"{value:.{self.decimals}f}")
    
    def set_warning(self, warning: bool):
        """设置警告状态"""
        if warning:
            self.value_label.setStyleSheet("""
                font-size: 24px;
                font-weight: bold;
                color: #ff4d4f;
                border: none;
                background: transparent;
            """)
        else:
            self.value_label.setStyleSheet("""
                font-size: 24px;
                font-weight: bold;
                color: #262626;
                border: none;
                background: transparent;
            """)


class MainWindow(QMainWindow):
    """
    CL-500W 电源控制器主界面
    
    现代化风格，参考专业设备控制软件设计
    """
    
    def __init__(self):
        super().__init__()
        
        self.power: Optional[CL500WDriver] = None
        self.poll_timer = QTimer(self)
        self.poll_timer.timeout.connect(self._poll_status)
        
        self._setup_ui()
        self._refresh_ports()
    
    def _setup_ui(self):
        """设置 UI"""
        self.setWindowTitle("多设备控制系统 - 电源控制")
        self.setMinimumSize(1000, 700)
        self.resize(1100, 780)
        
        # 应用样式
        self.setStyleSheet(MODERN_STYLE)
        
        # 温度串口相关属性
        self._temp_serial_1: Optional[serial.Serial] = None
        self._temp_serial_2: Optional[serial.Serial] = None
        self._temp_thread_1: Optional[threading.Thread] = None
        self._temp_thread_2: Optional[threading.Thread] = None
        self._temp_running_1 = False
        self._temp_running_2 = False
        
        # 中央部件
        central = QWidget()
        self.setCentralWidget(central)
        
        main_layout = QVBoxLayout(central)
        main_layout.setSpacing(0)
        main_layout.setContentsMargins(0, 0, 0, 0)
        
        # 可滚动内容区域
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setFrameShape(QFrame.NoFrame)
        scroll.setStyleSheet("QScrollArea { border: none; background-color: #f0f0f0; }")
        
        # 内容区域
        content = QWidget()
        content.setObjectName("content_area")
        content_layout = QVBoxLayout(content)
        content_layout.setSpacing(15)
        content_layout.setContentsMargins(20, 15, 20, 15)
        
        # 连接设置区域
        content_layout.addWidget(self._create_connection_section())
        
        # 主内容区域（电源控制）
        main_content = QHBoxLayout()
        main_content.setSpacing(20)
        
        # 左侧 - 参数设置
        main_content.addWidget(self._create_parameter_section(), stretch=1)
        
        # 中间 - 状态显示
        main_content.addWidget(self._create_status_section(), stretch=1)
        
        # 右侧 - 输出控制
        main_content.addWidget(self._create_output_section(), stretch=1)
        
        content_layout.addLayout(main_content)
        
        # 温度检测区域
        content_layout.addWidget(self._create_temperature_area())
        
        # 让内容区域填充剩余空间
        content_layout.addStretch()
        
        scroll.setWidget(content)
        main_layout.addWidget(scroll, stretch=1)
        
        # 温度更新定时器
        self._temp_update_timer = QTimer(self)
        self._temp_update_timer.timeout.connect(self._update_temp_display)
        self._temp_update_timer.start(200)
        
        # 温度数据缓存
        self._temp_data_1 = {'ds18b20': '--', 'hot': '--', 'cold': '--'}
        self._temp_data_2 = {'ds18b20': '--', 'hot': '--', 'cold': '--'}
    
    def _create_module_bar(self) -> QWidget:
        """创建模块选择栏"""
        bar = QWidget()
        bar.setStyleSheet("background-color: #fafafa; border-bottom: 1px solid #f0f0f0;")
        bar.setFixedHeight(50)
        
        layout = QHBoxLayout(bar)
        layout.setContentsMargins(15, 8, 15, 8)
        layout.setSpacing(10)
        
        # 模块标签
        label = QLabel("设备模块:")
        label.setStyleSheet("font-size: 13px; color: #595959; font-weight: bold;")
        layout.addWidget(label)
        
        # 电源控制按钮（当前激活）
        self.btn_power_module = QPushButton("电源控制")
        self.btn_power_module.setObjectName("module_btn_active")
        layout.addWidget(self.btn_power_module)
        
        # 其他模块按钮（示例）
        self.btn_other_module = QPushButton("其他设备")
        self.btn_other_module.setObjectName("module_btn_inactive")
        layout.addWidget(self.btn_other_module)
        
        layout.addStretch()
        
        return bar
    
    def _create_tab_bar(self) -> QWidget:
        """创建选项卡栏"""
        bar = QWidget()
        layout = QHBoxLayout(bar)
        layout.setContentsMargins(0, 0, 0, 10)
        layout.setSpacing(5)
        
        # Overview 按钮（激活状态）
        self.btn_tab_overview = QPushButton("Overview")
        self.btn_tab_overview.setObjectName("tab_btn_active")
        layout.addWidget(self.btn_tab_overview)
        
        # 高级设置按钮
        self.btn_tab_advanced = QPushButton("高级设置")
        self.btn_tab_advanced.setObjectName("tab_btn_inactive")
        layout.addWidget(self.btn_tab_advanced)
        
        layout.addStretch()
        
        # 三点菜单
        self.btn_menu = QPushButton("···")
        self.btn_menu.setFixedWidth(40)
        layout.addWidget(self.btn_menu)
        
        return bar
    
    def _create_connection_section(self) -> QFrame:
        """创建连接设置区域"""
        frame = QFrame()
        frame.setStyleSheet("""
            QFrame {
                background-color: #fafafa;
                border: 1px solid #f0f0f0;
                border-radius: 8px;
            }
        """)
        
        layout = QHBoxLayout(frame)
        layout.setContentsMargins(15, 10, 15, 10)
        layout.setSpacing(15)
        
        # 串口选择
        port_layout = QHBoxLayout()
        port_layout.setSpacing(8)
        port_label = QLabel("串口:")
        port_label.setStyleSheet("border: none;")
        port_layout.addWidget(port_label)
        self.combo_port = QComboBox()
        self.combo_port.setMinimumWidth(150)
        self.combo_port.setStyleSheet("border: 1px solid #d9d9d9; border-radius: 4px;")
        port_layout.addWidget(self.combo_port)
        layout.addLayout(port_layout)
        
        # 刷新按钮
        self.btn_refresh = QPushButton("刷新")
        self.btn_refresh.clicked.connect(self._refresh_ports)
        layout.addWidget(self.btn_refresh)
        
        # 波特率
        baud_layout = QHBoxLayout()
        baud_layout.setSpacing(8)
        baud_label = QLabel("波特率:")
        baud_label.setStyleSheet("border: none;")
        baud_layout.addWidget(baud_label)
        self.combo_baudrate = QComboBox()
        self.combo_baudrate.addItems(["9600", "19200", "38400", "57600", "115200"])
        self.combo_baudrate.setCurrentText("9600")
        self.combo_baudrate.setStyleSheet("border: 1px solid #d9d9d9; border-radius: 4px;")
        baud_layout.addWidget(self.combo_baudrate)
        layout.addLayout(baud_layout)
        
        # 从站地址
        addr_layout = QHBoxLayout()
        addr_layout.setSpacing(8)
        addr_label = QLabel("地址:")
        addr_label.setStyleSheet("border: none;")
        addr_layout.addWidget(addr_label)
        self.spin_address = QSpinBox()
        self.spin_address.setRange(1, 127)
        self.spin_address.setValue(1)
        self.spin_address.setFixedWidth(70)
        self.spin_address.setFixedHeight(28)
        addr_layout.addWidget(self.spin_address)
        layout.addLayout(addr_layout)
        
        layout.addStretch()
        
        # 连接按钮
        self.btn_connect = QPushButton("连接")
        self.btn_connect.setObjectName("success_btn")
        self.btn_connect.setFixedWidth(80)
        self.btn_connect.clicked.connect(self._connect)
        layout.addWidget(self.btn_connect)
        
        # 断开按钮
        self.btn_disconnect = QPushButton("断开")
        self.btn_disconnect.setObjectName("danger_btn")
        self.btn_disconnect.setFixedWidth(80)
        self.btn_disconnect.setEnabled(False)
        self.btn_disconnect.clicked.connect(self._disconnect)
        layout.addWidget(self.btn_disconnect)
        
        # 状态
        self.label_status = QLabel("● 未连接")
        self.label_status.setObjectName("status_disconnected")
        self.label_status.setStyleSheet("border: none; font-weight: bold;")
        layout.addWidget(self.label_status)
        
        return frame
    
    def _create_parameter_section(self) -> QFrame:
        """创建参数设置区域"""
        frame = QFrame()
        frame.setStyleSheet("""
            QFrame {
                background-color: #fafafa;
                border: 1px solid #f0f0f0;
                border-radius: 8px;
            }
        """)
        
        layout = QVBoxLayout(frame)
        layout.setContentsMargins(15, 12, 15, 12)
        layout.setSpacing(15)
        
        # 标题
        title = QLabel("参数设置")
        title.setObjectName("section_title")
        title.setStyleSheet("border: none; font-size: 14px; font-weight: bold; color: #262626;")
        layout.addWidget(title)
        
        # 电压设定
        voltage_group = QVBoxLayout()
        voltage_group.setSpacing(6)
        
        v_label = QLabel("设定电压")
        v_label.setStyleSheet("border: none; color: #8c8c8c;")
        voltage_group.addWidget(v_label)
        
        v_input_layout = QHBoxLayout()
        self.input_voltage = QDoubleSpinBox()
        self.input_voltage.setRange(0, 60)
        self.input_voltage.setDecimals(3)
        self.input_voltage.setSingleStep(0.1)
        self.input_voltage.setValue(12.0)
        self.input_voltage.setEnabled(False)
        self.input_voltage.setSuffix(" V")
        v_input_layout.addWidget(self.input_voltage)
        
        self.btn_set_voltage = QPushButton("设置")
        self.btn_set_voltage.setObjectName("primary_btn")
        self.btn_set_voltage.setFixedWidth(60)
        self.btn_set_voltage.setEnabled(False)
        self.btn_set_voltage.clicked.connect(self._set_voltage)
        v_input_layout.addWidget(self.btn_set_voltage)
        
        voltage_group.addLayout(v_input_layout)
        
        # 电压设定回读
        self.label_voltage_set = QLabel("当前设定: --")
        self.label_voltage_set.setStyleSheet("border: none; color: #1890ff; font-size: 11px;")
        voltage_group.addWidget(self.label_voltage_set)
        
        layout.addLayout(voltage_group)
        
        # 电流设定
        current_group = QVBoxLayout()
        current_group.setSpacing(6)
        
        i_label = QLabel("设定电流限制")
        i_label.setStyleSheet("border: none; color: #8c8c8c;")
        current_group.addWidget(i_label)
        
        i_input_layout = QHBoxLayout()
        self.input_current = QDoubleSpinBox()
        self.input_current.setRange(0, 20)
        self.input_current.setDecimals(3)
        self.input_current.setSingleStep(0.1)
        self.input_current.setValue(5.0)
        self.input_current.setEnabled(False)
        self.input_current.setSuffix(" A")
        i_input_layout.addWidget(self.input_current)
        
        self.btn_set_current = QPushButton("设置")
        self.btn_set_current.setObjectName("primary_btn")
        self.btn_set_current.setFixedWidth(60)
        self.btn_set_current.setEnabled(False)
        self.btn_set_current.clicked.connect(self._set_current)
        i_input_layout.addWidget(self.btn_set_current)
        
        current_group.addLayout(i_input_layout)
        
        # 电流设定回读
        self.label_current_set = QLabel("当前限制: --")
        self.label_current_set.setStyleSheet("border: none; color: #fa8c16; font-size: 11px;")
        current_group.addWidget(self.label_current_set)
        
        # 说明文字
        hint_label = QLabel("ℹ CV模式: 电流由负载决定\nCC模式: 负载电流>限制时触发")
        hint_label.setStyleSheet("border: none; color: #bfbfbf; font-size: 10px;")
        hint_label.setWordWrap(True)
        current_group.addWidget(hint_label)
        
        layout.addLayout(current_group)
        
        layout.addStretch()
        
        return frame
    
    def _create_status_section(self) -> QFrame:
        """创建状态显示区域"""
        frame = QFrame()
        frame.setStyleSheet("""
            QFrame {
                background-color: #fafafa;
                border: 1px solid #f0f0f0;
                border-radius: 8px;
            }
        """)
        
        layout = QVBoxLayout(frame)
        layout.setContentsMargins(15, 12, 15, 12)
        layout.setSpacing(12)
        
        # 标题
        title = QLabel("实时监测")
        title.setObjectName("section_title")
        title.setStyleSheet("border: none; font-size: 14px; font-weight: bold; color: #262626;")
        layout.addWidget(title)
        
        # 电压显示
        self.display_voltage = ValueDisplay("输出电压", "V", 3)
        layout.addWidget(self.display_voltage)
        
        # 电流显示
        self.display_current = ValueDisplay("输出电流", "A", 3)
        layout.addWidget(self.display_current)
        
        # 功率显示
        self.display_power = ValueDisplay("输出功率", "W", 2)
        layout.addWidget(self.display_power)
        
        # 模式和温度
        info_frame = QFrame()
        info_frame.setStyleSheet("border: none;")
        info_layout = QHBoxLayout(info_frame)
        info_layout.setContentsMargins(0, 5, 0, 0)
        info_layout.setSpacing(20)
        
        mode_layout = QHBoxLayout()
        mode_label = QLabel("模式:")
        mode_label.setStyleSheet("color: #8c8c8c;")
        mode_layout.addWidget(mode_label)
        self.label_mode = QLabel("--")
        self.label_mode.setStyleSheet("color: #1890ff; font-weight: bold;")
        mode_layout.addWidget(self.label_mode)
        info_layout.addLayout(mode_layout)
        
        temp_layout = QHBoxLayout()
        temp_label = QLabel("温度:")
        temp_label.setStyleSheet("color: #8c8c8c;")
        temp_layout.addWidget(temp_label)
        self.label_temp = QLabel("-- ℃")
        self.label_temp.setStyleSheet("color: #262626;")
        temp_layout.addWidget(self.label_temp)
        info_layout.addLayout(temp_layout)
        
        info_layout.addStretch()
        layout.addWidget(info_frame)
        
        layout.addStretch()
        
        return frame
    
    def _create_output_section(self) -> QFrame:
        """创建输出控制区域"""
        frame = QFrame()
        frame.setStyleSheet("""
            QFrame {
                background-color: #fafafa;
                border: 1px solid #f0f0f0;
                border-radius: 8px;
            }
        """)
        
        layout = QVBoxLayout(frame)
        layout.setContentsMargins(15, 12, 15, 12)
        layout.setSpacing(15)
        
        # 标题
        title = QLabel("输出控制")
        title.setObjectName("section_title")
        title.setStyleSheet("border: none; font-size: 14px; font-weight: bold; color: #262626;")
        layout.addWidget(title)
        
        # 输出状态指示
        status_frame = QFrame()
        status_frame.setStyleSheet("""
            QFrame {
                background-color: #ffffff;
                border: 2px solid #f0f0f0;
                border-radius: 8px;
            }
        """)
        status_layout = QVBoxLayout(status_frame)
        status_layout.setContentsMargins(15, 15, 15, 15)
        
        self.label_output_status = QLabel("输出状态")
        self.label_output_status.setStyleSheet("border: none; color: #8c8c8c; font-size: 12px;")
        self.label_output_status.setAlignment(Qt.AlignCenter)
        status_layout.addWidget(self.label_output_status)
        
        self.label_output_indicator = QLabel("--")
        self.label_output_indicator.setStyleSheet("""
            border: none;
            font-size: 20px;
            font-weight: bold;
            color: #bfbfbf;
        """)
        self.label_output_indicator.setAlignment(Qt.AlignCenter)
        status_layout.addWidget(self.label_output_indicator)
        
        layout.addWidget(status_frame)
        
        # 控制按钮
        btn_layout = QHBoxLayout()
        btn_layout.setSpacing(10)
        
        self.btn_output_on = QPushButton("开启输出")
        self.btn_output_on.setObjectName("success_btn")
        self.btn_output_on.setEnabled(False)
        self.btn_output_on.setMinimumHeight(40)
        self.btn_output_on.clicked.connect(self._output_on)
        btn_layout.addWidget(self.btn_output_on)
        
        self.btn_output_off = QPushButton("关闭输出")
        self.btn_output_off.setObjectName("danger_btn")
        self.btn_output_off.setEnabled(False)
        self.btn_output_off.setMinimumHeight(40)
        self.btn_output_off.clicked.connect(self._output_off)
        btn_layout.addWidget(self.btn_output_off)
        
        layout.addLayout(btn_layout)
        
        # 保护状态
        protection_frame = QFrame()
        protection_frame.setStyleSheet("border: none;")
        protection_layout = QHBoxLayout(protection_frame)
        protection_layout.setContentsMargins(0, 10, 0, 0)
        
        prot_label = QLabel("保护状态:")
        prot_label.setStyleSheet("color: #8c8c8c;")
        protection_layout.addWidget(prot_label)
        
        self.label_protection = QLabel("正常")
        self.label_protection.setStyleSheet("color: #52c41a; font-weight: bold;")
        protection_layout.addWidget(self.label_protection)
        protection_layout.addStretch()
        
        layout.addWidget(protection_frame)
        
        layout.addStretch()
        
        return frame
    
    def _create_temperature_area(self) -> QFrame:
        """创建温度检测区域（包含左右两个面板）"""
        frame = QFrame()
        frame.setStyleSheet("QFrame { border: none; background: transparent; }")
        
        layout = QHBoxLayout(frame)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(20)
        
        # 温度检测1（左侧）
        layout.addWidget(self._create_temp_panel(1), stretch=1)
        
        # 温度检测2（右侧）
        layout.addWidget(self._create_temp_panel(2), stretch=1)
        
        return frame
    
    def _create_temp_panel(self, index: int) -> QFrame:
        """创建单个温度检测面板"""
        frame = QFrame()
        frame.setStyleSheet("""
            QFrame {
                background-color: #fafafa;
                border: 1px solid #f0f0f0;
                border-radius: 8px;
            }
        """)
        
        layout = QVBoxLayout(frame)
        layout.setContentsMargins(15, 12, 15, 12)
        layout.setSpacing(12)
        
        # 标题
        title = QLabel(f"温度检测 {index}")
        title.setObjectName("section_title")
        title.setStyleSheet("border: none; font-size: 14px; font-weight: bold; color: #262626;")
        layout.addWidget(title)
        
        # 串口连接区域
        conn_frame = QFrame()
        conn_frame.setStyleSheet("""
            QFrame {
                background-color: #ffffff;
                border: 1px solid #f0f0f0;
                border-radius: 6px;
            }
        """)
        conn_layout = QHBoxLayout(conn_frame)
        conn_layout.setContentsMargins(10, 8, 10, 8)
        conn_layout.setSpacing(8)
        
        port_label = QLabel("串口:")
        port_label.setStyleSheet("border: none; color: #8c8c8c;")
        conn_layout.addWidget(port_label)
        
        combo_port = QComboBox()
        combo_port.setMinimumWidth(180)
        combo_port.setStyleSheet("border: 1px solid #d9d9d9; border-radius: 4px;")
        conn_layout.addWidget(combo_port, stretch=1)
        
        btn_refresh = QPushButton("刷新")
        btn_refresh.setFixedWidth(50)
        conn_layout.addWidget(btn_refresh)
        
        btn_connect = QPushButton("连接")
        btn_connect.setObjectName("success_btn")
        btn_connect.setFixedWidth(60)
        conn_layout.addWidget(btn_connect)
        
        btn_disconnect = QPushButton("断开")
        btn_disconnect.setObjectName("danger_btn")
        btn_disconnect.setFixedWidth(60)
        btn_disconnect.setEnabled(False)
        conn_layout.addWidget(btn_disconnect)
        
        status_label = QLabel("● 未连接")
        status_label.setStyleSheet("border: none; font-weight: bold; color: #ff4d4f;")
        conn_layout.addWidget(status_label)
        
        layout.addWidget(conn_frame)
        
        # 温度显示区域 - DS18B20
        ds_display = ValueDisplay("DS18B20 温度", "℃", 2)
        layout.addWidget(ds_display)
        
        # 热端温度
        hot_display = ValueDisplay("热端温度", "℃", 2)
        layout.addWidget(hot_display)
        
        # 冷端温度
        cold_display = ValueDisplay("冷端温度", "℃", 2)
        layout.addWidget(cold_display)
        
        # 保存引用
        if index == 1:
            self.temp1_combo_port = combo_port
            self.temp1_btn_refresh = btn_refresh
            self.temp1_btn_connect = btn_connect
            self.temp1_btn_disconnect = btn_disconnect
            self.temp1_status_label = status_label
            self.temp1_ds_display = ds_display
            self.temp1_hot_display = hot_display
            self.temp1_cold_display = cold_display
            
            btn_refresh.clicked.connect(lambda: self._refresh_temp_ports(1))
            btn_connect.clicked.connect(lambda: self._connect_temp(1))
            btn_disconnect.clicked.connect(lambda: self._disconnect_temp(1))
            self._refresh_temp_ports(1)
        else:
            self.temp2_combo_port = combo_port
            self.temp2_btn_refresh = btn_refresh
            self.temp2_btn_connect = btn_connect
            self.temp2_btn_disconnect = btn_disconnect
            self.temp2_status_label = status_label
            self.temp2_ds_display = ds_display
            self.temp2_hot_display = hot_display
            self.temp2_cold_display = cold_display
            
            btn_refresh.clicked.connect(lambda: self._refresh_temp_ports(2))
            btn_connect.clicked.connect(lambda: self._connect_temp(2))
            btn_disconnect.clicked.connect(lambda: self._disconnect_temp(2))
            self._refresh_temp_ports(2)
        
        return frame
    
    def _refresh_temp_ports(self, index: int):
        """刷新温度串口列表"""
        combo = self.temp1_combo_port if index == 1 else self.temp2_combo_port
        combo.clear()
        ports = serial.tools.list_ports.comports()
        for port in ports:
            combo.addItem(f"{port.device} - {port.description}", port.device)
        if not ports:
            combo.addItem("(无可用串口)", "")
    
    def _connect_temp(self, index: int):
        """连接温度传感器串口"""
        combo = self.temp1_combo_port if index == 1 else self.temp2_combo_port
        port = combo.currentData()
        if not port:
            QMessageBox.warning(self, "错误", "请选择有效的串口")
            return
        
        try:
            ser = serial.Serial(port, 115200, timeout=1)
            if index == 1:
                self._temp_serial_1 = ser
                self._temp_running_1 = True
                self._temp_thread_1 = threading.Thread(target=self._read_temp_data, args=(1,), daemon=True)
                self._temp_thread_1.start()
                self._set_temp_connected_state(1, True)
            else:
                self._temp_serial_2 = ser
                self._temp_running_2 = True
                self._temp_thread_2 = threading.Thread(target=self._read_temp_data, args=(2,), daemon=True)
                self._temp_thread_2.start()
                self._set_temp_connected_state(2, True)
        except Exception as e:
            QMessageBox.critical(self, "错误", f"连接温度串口失败: {e}")
    
    def _disconnect_temp(self, index: int):
        """断开温度传感器串口"""
        if index == 1:
            self._temp_running_1 = False
            if self._temp_serial_1:
                try:
                    self._temp_serial_1.close()
                except:
                    pass
                self._temp_serial_1 = None
            self._temp_data_1 = {'ds18b20': '--', 'hot': '--', 'cold': '--'}
            self._set_temp_connected_state(1, False)
        else:
            self._temp_running_2 = False
            if self._temp_serial_2:
                try:
                    self._temp_serial_2.close()
                except:
                    pass
                self._temp_serial_2 = None
            self._temp_data_2 = {'ds18b20': '--', 'hot': '--', 'cold': '--'}
            self._set_temp_connected_state(2, False)
    
    def _set_temp_connected_state(self, index: int, connected: bool):
        """设置温度串口连接状态 UI"""
        if index == 1:
            combo = self.temp1_combo_port
            btn_c = self.temp1_btn_connect
            btn_d = self.temp1_btn_disconnect
            btn_r = self.temp1_btn_refresh
            lbl = self.temp1_status_label
        else:
            combo = self.temp2_combo_port
            btn_c = self.temp2_btn_connect
            btn_d = self.temp2_btn_disconnect
            btn_r = self.temp2_btn_refresh
            lbl = self.temp2_status_label
        
        combo.setEnabled(not connected)
        btn_c.setEnabled(not connected)
        btn_d.setEnabled(connected)
        btn_r.setEnabled(not connected)
        
        if connected:
            lbl.setText("● 已连接")
            lbl.setStyleSheet("border: none; font-weight: bold; color: #52c41a;")
        else:
            lbl.setText("● 未连接")
            lbl.setStyleSheet("border: none; font-weight: bold; color: #ff4d4f;")
    
    def _read_temp_data(self, index: int):
        """后台线程：读取温度数据"""
        ser = self._temp_serial_1 if index == 1 else self._temp_serial_2
        buffer = ""
        
        while (self._temp_running_1 if index == 1 else self._temp_running_2):
            try:
                if ser and ser.is_open:
                    data = ser.read(ser.in_waiting or 1)
                    if data:
                        try:
                            text = data.decode('utf-8', errors='ignore')
                        except:
                            text = data.decode('gbk', errors='ignore')
                        buffer += text
                        
                        # 按行解析
                        while '\n' in buffer:
                            line, buffer = buffer.split('\n', 1)
                            line = line.strip()
                            self._parse_temp_line(index, line)
            except Exception as e:
                print(f"温度读取错误 (传感器{index}): {e}")
                break
    
    def _parse_temp_line(self, index: int, line: str):
        """解析温度数据行"""
        data = self._temp_data_1 if index == 1 else self._temp_data_2
        
        # 匹配 DS18B20 温度: 23.81 ℃
        m = re.search(r'DS18B20\s*温度[：:]\s*([\d.]+)', line)
        if m:
            data['ds18b20'] = m.group(1)
            return
        
        # 匹配 热端温度: 20.12 ℃
        m = re.search(r'热端温度[：:]\s*([\d.]+)', line)
        if m:
            data['hot'] = m.group(1)
            return
        
        # 匹配 冷端温度: 23.89 ℃
        m = re.search(r'冷端温度[：:]\s*([\d.]+)', line)
        if m:
            data['cold'] = m.group(1)
            return
    
    def _update_temp_display(self):
        """定时更新温度显示（在主线程中）"""
        # 温度检测1
        d1 = self._temp_data_1
        if d1['ds18b20'] != '--':
            try:
                self.temp1_ds_display.set_value(float(d1['ds18b20']))
            except ValueError:
                pass
        if d1['hot'] != '--':
            try:
                self.temp1_hot_display.set_value(float(d1['hot']))
            except ValueError:
                pass
        if d1['cold'] != '--':
            try:
                self.temp1_cold_display.set_value(float(d1['cold']))
            except ValueError:
                pass
        
        # 温度检测2
        d2 = self._temp_data_2
        if d2['ds18b20'] != '--':
            try:
                self.temp2_ds_display.set_value(float(d2['ds18b20']))
            except ValueError:
                pass
        if d2['hot'] != '--':
            try:
                self.temp2_hot_display.set_value(float(d2['hot']))
            except ValueError:
                pass
        if d2['cold'] != '--':
            try:
                self.temp2_cold_display.set_value(float(d2['cold']))
            except ValueError:
                pass
    
    def _create_gauge_section(self) -> QFrame:
        """创建仪表盘区域"""
        frame = QFrame()
        frame.setStyleSheet("""
            QFrame {
                background-color: #fafafa;
                border: 1px solid #f0f0f0;
                border-radius: 8px;
            }
        """)
        
        layout = QHBoxLayout(frame)
        layout.setContentsMargins(20, 15, 20, 15)
        layout.setSpacing(30)
        
        # 标题
        title = QLabel("输出仪表")
        title.setStyleSheet("border: none; font-size: 14px; font-weight: bold; color: #262626;")
        layout.addWidget(title)
        
        layout.addStretch()
        
        # 电压仪表
        self.gauge_voltage = CircularGauge("电压 (V)", "V", 0, 60, "#ff4d4f")
        layout.addWidget(self.gauge_voltage)
        
        # 电流仪表
        self.gauge_current = CircularGauge("电流 (A)", "A", 0, 20, "#52c41a")
        layout.addWidget(self.gauge_current)
        
        # 功率仪表
        self.gauge_power = CircularGauge("功率 (W)", "W", 0, 500, "#1890ff")
        layout.addWidget(self.gauge_power)
        
        layout.addStretch()
        
        return frame
    
    def _create_status_bar(self) -> QFrame:
        """创建状态栏"""
        bar = QFrame()
        bar.setObjectName("status_bar")
        bar.setFixedHeight(30)
        
        layout = QHBoxLayout(bar)
        layout.setContentsMargins(15, 0, 15, 0)
        
        self.label_info = QLabel("CL-500W 可调电源控制器 v2.0 | 现代化界面")
        self.label_info.setStyleSheet("color: #8c8c8c; font-size: 11px;")
        layout.addWidget(self.label_info)
        
        layout.addStretch()
        
        return bar
    
    # ==================== 槽函数 ====================
    
    def _refresh_ports(self):
        """刷新串口列表"""
        self.combo_port.clear()
        ports = serial.tools.list_ports.comports()
        for port in ports:
            self.combo_port.addItem(f"{port.device} - {port.description}", port.device)
        
        if not ports:
            self.combo_port.addItem("(无可用串口)", "")
    
    def _connect(self):
        """连接电源"""
        port = self.combo_port.currentData()
        if not port:
            QMessageBox.warning(self, "错误", "请选择有效的串口")
            return
        
        baudrate = int(self.combo_baudrate.currentText())
        address = self.spin_address.value()
        
        try:
            self.power = CL500WDriver(
                port=port,
                slave_address=address,
                baudrate=baudrate
            )
            
            if self.power.connect():
                self._set_connected_state(True)
                self.poll_timer.start(500)
            else:
                QMessageBox.warning(self, "错误", "连接失败，请检查串口和电源")
                self.power = None
                
        except Exception as e:
            QMessageBox.critical(self, "错误", f"连接异常: {e}")
            self.power = None
    
    def _disconnect(self):
        """断开连接"""
        self.poll_timer.stop()
        
        if self.power:
            self.power.disconnect()
            self.power = None
        
        self._set_connected_state(False)
    
    def _set_connected_state(self, connected: bool):
        """设置连接状态 UI"""
        self.btn_connect.setEnabled(not connected)
        self.btn_disconnect.setEnabled(connected)
        self.combo_port.setEnabled(not connected)
        self.combo_baudrate.setEnabled(not connected)
        self.spin_address.setEnabled(not connected)
        
        self.input_voltage.setEnabled(connected)
        self.input_current.setEnabled(connected)
        self.btn_set_voltage.setEnabled(connected)
        self.btn_set_current.setEnabled(connected)
        self.btn_output_on.setEnabled(connected)
        self.btn_output_off.setEnabled(connected)
        
        if connected:
            self.label_status.setText("● 已连接")
            self.label_status.setObjectName("status_connected")
            self.label_status.setStyleSheet("border: none; font-weight: bold; color: #52c41a;")
        else:
            self.label_status.setText("● 未连接")
            self.label_status.setObjectName("status_disconnected")
            self.label_status.setStyleSheet("border: none; font-weight: bold; color: #ff4d4f;")
            
            # 重置显示
            self.display_voltage.set_value(0)
            self.display_current.set_value(0)
            self.display_power.set_value(0)
            self.label_mode.setText("--")
            self.label_temp.setText("-- ℃")
            self.label_output_indicator.setText("--")
            self.label_output_indicator.setStyleSheet("border: none; font-size: 20px; font-weight: bold; color: #bfbfbf;")
    
    def _poll_status(self):
        """轮询状态"""
        if not self.power or not self.power.is_connected:
            return
        
        try:
            status = self.power.get_status()
            self._update_display(status)
        except Exception as e:
            print(f"轮询错误: {e}")
    
    def _update_display(self, status: PowerStatus):
        """更新显示"""
        # 数值显示
        self.display_voltage.set_value(status.voltage_real)
        self.display_current.set_value(status.current_real)
        power = status.voltage_real * status.current_real
        self.display_power.set_value(power)
        
        # 设定值回读
        if status.voltage_set > 0:
            self.label_voltage_set.setText(f"当前设定: {status.voltage_set:.3f} V")
        if status.current_set > 0:
            self.label_current_set.setText(f"当前限制: {status.current_set:.3f} A")
        
        # 模式 - 只有输出开启时才显示
        if status.is_output_on:
            if status.mode == PowerMode.CV:
                self.label_mode.setText("CV")
                self.label_mode.setStyleSheet("color: #1890ff; font-weight: bold;")
            else:
                self.label_mode.setText("CC")
                self.label_mode.setStyleSheet("color: #fa8c16; font-weight: bold;")
        else:
            self.label_mode.setText("--")
            self.label_mode.setStyleSheet("color: #bfbfbf; font-weight: bold;")
        
        # 温度
        self.label_temp.setText(f"{status.temperature:.0f} ℃")
        
        # 输出状态
        if status.is_output_on:
            self.label_output_indicator.setText("ON")
            self.label_output_indicator.setStyleSheet("""
                border: none;
                font-size: 20px;
                font-weight: bold;
                color: #52c41a;
            """)
        else:
            self.label_output_indicator.setText("OFF")
            self.label_output_indicator.setStyleSheet("""
                border: none;
                font-size: 20px;
                font-weight: bold;
                color: #ff4d4f;
            """)
        
        # 保护状态
        if status.protection == ProtectionStatus.NORMAL:
            self.label_protection.setText("正常")
            self.label_protection.setStyleSheet("color: #52c41a; font-weight: bold;")
            self.display_voltage.set_warning(False)
            self.display_current.set_warning(False)
        else:
            self.label_protection.setText(status.protection.value)
            self.label_protection.setStyleSheet("color: #ff4d4f; font-weight: bold;")
            self.display_voltage.set_warning(True)
            self.display_current.set_warning(True)
    
    def _set_voltage(self):
        """设置电压"""
        if self.power:
            voltage = self.input_voltage.value()
            if self.power.set_voltage(voltage):
                print(f"电压设置为: {voltage}V")
            else:
                QMessageBox.warning(self, "错误", "设置电压失败")
    
    def _set_current(self):
        """设置电流"""
        if self.power:
            current = self.input_current.value()
            if self.power.set_current(current):
                print(f"电流设置为: {current}A")
            else:
                QMessageBox.warning(self, "错误", "设置电流失败")
    
    def _output_on(self):
        """开启输出"""
        if self.power:
            if self.power.output_on():
                print("输出已开启")
            else:
                QMessageBox.warning(self, "错误", "开启输出失败")
    
    def _output_off(self):
        """关闭输出"""
        if self.power:
            if self.power.output_off():
                print("输出已关闭")
            else:
                QMessageBox.warning(self, "错误", "关闭输出失败")
    
    def closeEvent(self, event):
        """关闭窗口事件"""
        self._disconnect()
        self._disconnect_temp(1)
        self._disconnect_temp(2)
        event.accept()


def main():
    """主函数"""
    app = QApplication(sys.argv)
    
    # 设置应用信息
    app.setApplicationName("多设备控制系统")
    app.setOrganizationName("AI Team")
    
    window = MainWindow()
    window.show()
    
    sys.exit(app.exec())


if __name__ == "__main__":
    main()
